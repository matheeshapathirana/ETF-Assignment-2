<!DOCTYPE html>
<html lang="en">
<head>
    <title>Update Patients - Hospital Management System</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1;
        }
        .dark-mode {
            background-color: #181a1b !important;
            color: #f8f9fa !important;
        }
        .dark-mode .bg-dark {
            background-color: #23272b !important;
        }
        .dark-mode .navbar,
        .dark-mode footer {
            background-color: #23272b !important;
        }
        .dark-mode .form-control,
        .dark-mode .form-select {
            background-color: #2c3034 !important;
            color: #f8f9fa !important;
            border-color: #495057 !important;
        }
        .dark-mode .form-control:focus,
        .dark-mode .form-select:focus {
            background-color: #2c3034 !important;
            color: #f8f9fa !important;
            border-color: #80bdff !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .dark-mode .text-dark {
            color: #f8f9fa !important;
        }
        .dark-mode .bg-white {
            background-color: #23272b !important;
        }
        .dark-mode .btn-outline-light {
            border-color: #adb5bd;
            color: #adb5bd;
        }
        .dark-mode .btn-outline-light:hover {
            background-color: #f8f9fa;
            color: #212529;
        }
        .dark-mode .form-section-container {
            border-color: #495057;
        }
        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: #dc3545;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        }
        .dark-mode .form-control.is-invalid,
        .dark-mode .form-select.is-invalid {
            border-color: #dc3545 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        }
        .form-section-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #e0a800;
        }
        .btn-danger {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <script>
        $(document).ready(function() {
            // Dark mode setup
            const btn = $('<button type="button" id="toggleDarkMode" class="btn btn-outline-light ms-2" style="min-width:110px;">Dark Mode</button>');
            function setDarkMode(isDark) {
                $('body, html').toggleClass('dark-mode', isDark);
                btn.text(isDark ? 'Light Mode' : 'Dark Mode');
                localStorage.setItem('darkMode', isDark ? '1' : '0');
            }
            $('.navbar .container-fluid').append(btn);
            setDarkMode(localStorage.getItem('darkMode') === '1');
            btn.on('click', function() {
                setDarkMode(!$('body').hasClass('dark-mode'));
            });

            // Set default last visit date
            $("#editLastVisit").val(new Date().toISOString().split("T")[0]);

            // Name capitalization
            $("#editFirstName, #editLastName").on("blur", function() {
                const val = $(this).val();
                if (val.length > 0) {
                    $(this).val(val.charAt(0).toUpperCase() + val.slice(1).toLowerCase());
                }
            });

            // Form validation feedback
            $('#searchPatientForm, #updatePatientForm').on('input change', 'input[required], select[required]', function() {
                if ($(this).val().trim() === '') {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            $('#editEmail').on('input', function() {
                const email = $(this).val().trim();
                if (email && !/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });

            // Fetch patient data
            function fetchPatients(callback) {
                let patients = JSON.parse(localStorage.getItem('patients')) || [];
                console.log('Raw patients from localStorage:', patients);
                if (patients.length > 0) {
                    if (patients.patients) patients = patients.patients;
                    if (patients.Patients) patients = patients.Patients;
                    callback(patients);
                } else {
                    $.getJSON('patients.json')
                        .done(function(data) {
                            console.log('Raw patients from patients.json:', data);
                            let patientsData = data;
                            if (data.patients) patientsData = data.patients;
                            if (data.Patients) patientsData = data.Patients;
                            localStorage.setItem('patients', JSON.stringify(patientsData));
                            callback(patientsData);
                        })
                        .fail(function(jqxhr, textStatus, error) {
                            console.error("Error loading patient data:", textStatus, error);
                            alert('Error loading patient data. Please try again later.');
                            callback([]);
                        });
                }
            }

            // Search patient form submission
            $('#searchPatientForm').submit(function(e) {
                e.preventDefault();
                const searchType = $('#searchType').val();
                const searchTerm = $('#searchTerm').val().trim().toLowerCase();
                console.log('Search Type:', searchType, 'Search Term:', searchTerm);
                if (!searchType || !searchTerm) {
                    alert('Please select a search type and enter a term.');
                    $('#searchType, #searchTerm').each(function() {
                        if (!$(this).val()) $(this).addClass('is-invalid');
                    });
                    return;
                }
                fetchPatients(function(patients) {
                    console.log('Patients being searched:', patients);
                    const foundPatient = patients.find(patient => {
                        if (!patient) return false;
                        if (searchType === 'pid') {
                            return String(patient.PID || patient.pid || '').trim().toLowerCase() === searchTerm;
                        }
                        if (searchType === 'firstName') {
                            return String(patient.FirstName || patient.firstName || '').trim().toLowerCase() === searchTerm;
                        }
                        return false;
                    });
                    if (foundPatient) {
                        console.log('Found Patient:', foundPatient);
                        $('#originalPid').val(foundPatient.PID || foundPatient.pid);
                        $('#editPid').val(foundPatient.PID || foundPatient.pid);
                        $('#editFirstName').val(foundPatient.FirstName || foundPatient.firstName);
                        $('#editLastName').val(foundPatient.LastName || foundPatient.lastName);
                        $('#editEmail').val(foundPatient.Email || foundPatient.email || '');
                        $('#editGuardian').val(foundPatient.Guardian || foundPatient.guardian);
                        $('#editNearCity').val(foundPatient.NearCity || foundPatient.nearCity);
                        $('#editDoctor').val(foundPatient.Doctor || foundPatient.doctor);
                        $('#editMedications').val(foundPatient.Medications && Array.isArray(foundPatient.Medications) ? foundPatient.Medications.join(', ') : foundPatient.Medications || '');
                        $('#editMedicalConditions').val(foundPatient.MedicalConditions && Array.isArray(foundPatient.MedicalConditions) ? foundPatient.MedicalConditions.join(', ') : foundPatient.MedicalConditions || '');
                        $('#editAllergies').val(foundPatient.Allergies && Array.isArray(foundPatient.Allergies) ? foundPatient.Allergies.join(', ') : foundPatient.Allergies || foundPatient.allergies || '');
                        $('#editStatus').val(foundPatient.Status || foundPatient.status || 'Alive');
                        $('#editLastVisit').val(foundPatient.LastVisitDate || foundPatient.lastVisit || new Date().toISOString().split("T")[0]);
                        $('#deletePatientBtn').toggle(searchType === 'pid');
                        $('#patientFormContainer').show();
                    } else {
                        alert('Patient not found. Please try another search term.');
                        $('#patientFormContainer').hide();
                    }
                });
            });

            // Update patient form submission
            $('#updatePatientForm').submit(function(e) {
                e.preventDefault();
                let isValid = true;
                $(this).find('input[required], select[required]').each(function() {
                    if ($(this).val().trim() === '') {
                        $(this).addClass('is-invalid');
                        isValid = false;
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });
                if (!isValid) {
                    alert('Please fill all required fields.');
                    return;
                }
                const email = $('#editEmail').val().trim();
                if (email && !/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
                    alert('Please enter a valid email address.');
                    $('#editEmail').addClass('is-invalid');
                    return;
                } else {
                    $('#editEmail').removeClass('is-invalid');
                }
                const originalPid = $('#originalPid').val();
                const updatedPatient = {
                    PID: $('#editPid').val(),
                    FirstName: $('#editFirstName').val(),
                    LastName: $('#editLastName').val(),
                    Email: $('#editEmail').val(),
                    Guardian: $('#editGuardian').val(),
                    NearCity: $('#editNearCity').val(),
                    Doctor: $('#editDoctor').val(),
                    Medications: $('#editMedications').val() ? $('#editMedications').val().split(',').map(s => s.trim()).filter(s => s) : [],
                    MedicalConditions: $('#editMedicalConditions').val() ? $('#editMedicalConditions').val().split(',').map(s => s.trim()).filter(s => s) : [],
                    Allergies: $('#editAllergies').val() ? $('#editAllergies').val().split(',').map(s => s.trim()).filter(s => s) : [],
                    Status: $('#editStatus').val(),
                    LastVisitDate: $('#editLastVisit').val()
                };
                console.log('Updating patient:', updatedPatient);
                let patients = JSON.parse(localStorage.getItem('patients')) || [];
                if (patients.patients) patients = patients.patients;
                if (patients.Patients) patients = patients.Patients;
                const idx = patients.findIndex(p => String(p.PID || p.pid || '').trim() === String(originalPid).trim());
                if (idx !== -1) {
                    patients[idx] = updatedPatient;
                    localStorage.setItem('patients', JSON.stringify(patients));
                    alert('Patient updated successfully!');
                    $('#updatePatientForm')[0].reset();
                    $('#patientFormContainer').hide();
                    $('#deletePatientBtn').hide();
                    $("#editLastVisit").val(new Date().toISOString().split("T")[0]);
                } else {
                    alert('Patient not found.');
                }
            });

            // Delete patient button
            $('#deletePatientBtn').click(function() {
                if (confirm('Are you sure you want to delete this patient record?')) {
                    const pid = $('#originalPid').val();
                    let patients = JSON.parse(localStorage.getItem('patients')) || [];
                    if (patients.patients) patients = patients.patients;
                    if (patients.Patients) patients = patients.Patients;
                    patients = patients.filter(p => String(p.PID || p.pid || '').trim() !== String(pid).trim());
                    localStorage.setItem('patients', JSON.stringify(patients));
                    alert('Patient deleted successfully.');
                    $('#updatePatientForm')[0].reset();
                    $('#patientFormContainer').hide();
                    $('#deletePatientBtn').hide();
                    $("#editLastVisit").val(new Date().toISOString().split("T")[0]);
                }
            });
        });
    </script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">⛨ Hospital Management System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" style="gap: 1.5rem;">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="add_patient.html">Add Patient</a></li>
                    <li class="nav-item"><a class="nav-link" href="view_patients.html">View Patients</a></li>
                    <li class="nav-item"><a class="nav-link active" href="update_patients.html">Update Patients</a></li>
                    <li class="nav-item"><a class="nav-link" href="search_patients.html">Search</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <div class="container mt-4">
            <h3 class="text-center mb-4">Update Patient Records</h3>
            <div class="form-section-container">
                <div class="bg-dark text-white px-3 py-2">
                    <h5 class="mb-0">Search Patient by Type</h5>
                </div>
                <section class="p-4">
                    <form id="searchPatientForm" class="row g-3 justify-content-center align-items-end">
                        <div class="col-md-4">
                            <label for="searchType" class="form-label">Search by</label>
                            <select class="form-select" id="searchType" name="searchType" required>
                                <option value="">Select option</option>
                                <option value="pid">Patient ID</option>
                                <option value="firstName">First Name</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="searchTerm" class="form-label">Search term</label>
                            <input type="text" class="form-control" id="searchTerm" name="searchTerm" placeholder="Enter ID or name" required>
                        </div>
                        <div class="col-md-4 d-grid">
                            <button type="submit" class="btn btn-warning">Search</button>
                        </div>
                    </form>
                </section>
            </div>
            <div id="patientFormContainer" style="display:none;">
                <div class="form-section-container">
                    <div class="bg-dark text-white px-3 py-2">
                        <h5 class="mb-0 text-center">Edit Patient Details</h5>
                    </div>
                    <div class="p-4">
                        <form id="updatePatientForm" class="col-md-10 mx-auto">
                            <input type="hidden" id="originalPid">
                            <div class="row mb-3">
                                <div class="col-md-4 mb-3">
                                    <label for="editPid" class="form-label">Patient ID</label>
                                    <input type="text" class="form-control" id="editPid" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="editFirstName" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="editLastName" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12 mb-3">
                                    <label for="editEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editEmail">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="editGuardian" class="form-label">Guardian</label>
                                    <input type="text" class="form-control" id="editGuardian" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editNearCity" class="form-label">Nearest City</label>
                                    <input type="text" class="form-control" id="editNearCity" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="editDoctor" class="form-label">Doctor</label>
                                    <input type="text" class="form-control" id="editDoctor" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editMedications" class="form-label">Medications</label>
                                    <input type="text" class="form-control" id="editMedications" placeholder="Comma separated list">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12 mb-3">
                                    <label for="editMedicalConditions" class="form-label">Medical Conditions (comma-separated)</label>
                                    <input type="text" class="form-control" id="editMedicalConditions" placeholder="Comma separated list">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 mb-3">
                                    <label for="editAllergies" class="form-label">Allergies</label>
                                    <input type="text" class="form-control" id="editAllergies" placeholder="Comma separated list">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editStatus" required>
                                        <option value="Alive">Alive</option>
                                        <option value="Deceased">Deceased</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editLastVisit" class="form-label">Last Visit</label>
                                    <input type="date" class="form-control" id="editLastVisit">
                                </div>
                            </div>
                            <button type="button" id="deletePatientBtn" class="btn btn-danger w-100" style="display:none;">Delete Patient</button>
                            <button type="submit" class="btn btn-warning w-100">Update Patient</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <nav class="mb-3">
                <a href="index.html" class="text-decoration-none text-light mx-2">Home</a>
                <a href="add_patient.html" class="text-decoration-none text-light mx-2">Add Patients</a>
                <a href="view_patients.html" class="text-decoration-none text-light mx-2">View Patients</a>
                <a href="update_patients.html" class="text-decoration-none text-light mx-2">Update Patients</a>
                <a href="search_patients.html" class="text-decoration-none text-light mx-2">Search</a>
            </nav>
            <hr class="border-secondary my-3" style="max-width: 600px; margin: auto;">
            <p class="mb-0">© 2025 Hospital Management System - All Rights Reserved</p>
        </div>
    </footer>
</body>
</html>